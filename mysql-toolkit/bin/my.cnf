#############################################################
# MySQL 8.x — HIGH PERFORMANCE CONFIG (32 GB RAM, HDD SERVER)
# Optimized for: high concurrency, slow disks, OLTP workloads
# Memory target: ~22-24 GB allocated to MySQL, safe for HDD
# Author: Julio (2025)
# Place in: /etc/mysql/my.cnf
#############################################################

[client]
default-character-set = utf8mb4
socket = /var/run/mysqld/mysqld.sock

[mysql]
default-character-set = utf8mb4
no-auto-rehash

[mysqld]
#############################################################
# BASIC SETTINGS
#############################################################
user = mysql
pid-file = /run/mysqld/mysqld.pid
socket = /var/run/mysqld/mysqld.sock
datadir = /var/lib/mysql
tmpdir = /tmp
skip-external-locking

sql_mode = STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION

#############################################################
# CHARACTER SETS
#############################################################
character-set-server = utf8mb4
collation-server = utf8mb4_0900_ai_ci

#############################################################
# CONNECTION SETTINGS
#############################################################
max_connections = 400
max_connect_errors = 1000000
thread_cache_size = 200
back_log = 1200

#############################################################
# INNODB — OPTIMIZED *FOR HDD DRIVES*
#############################################################
default_storage_engine = InnoDB

# HDD: These values reduce random writes and spindle thrashing.

innodb_buffer_pool_size = 18G
innodb_buffer_pool_instances = 16
innodb_log_file_size = 1G             # Smaller logs reduce stall time on HDD
innodb_log_buffer_size = 256M
innodb_flush_log_at_trx_commit = 2    # BEST SETTING FOR HDD (reduces fsync)
innodb_flush_method = fsync           # fsync recommended for rotating disks
innodb_doublewrite = ON               # Must stay on for HDD durability

innodb_file_per_table = 1
innodb_read_io_threads = 4
innodb_write_io_threads = 4

# HDD I/O capability is much lower, keep moderate:
innodb_io_capacity = 200
innodb_io_capacity_max = 400

innodb_flush_neighbors = 1    # ON for HDD to group writes physically

#############################################################
# TMP TABLES & MEMORY (uses ~2 GB RAM)
#############################################################
tmp_table_size = 256M
max_heap_table_size = 256M
join_buffer_size = 8M
sort_buffer_size = 8M
read_buffer_size = 4M
read_rnd_buffer_size = 4M

#############################################################
# NETWORKING
#############################################################
max_allowed_packet = 512M
net_read_timeout = 120
net_write_timeout = 120

#############################################################
# LOGGING CONFIGURATION
#############################################################
log_error = /var/log/mysql/error.log

slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 1.2       # HDD → slower disk, 1.2 sec is realistic
log_queries_not_using_indexes = OFF

#############################################################
# BINARY LOGGING (safe defaults)
#############################################################
server-id = 1
log_bin = /var/log/mysql/mysql-bin.log
binlog_format = ROW
sync_binlog = 2       # HDD: avoid fsync storm (safe compromise)
binlog_expire_logs_seconds = 604800   # 7 days

#############################################################
# PERFORMANCE SCHEMA
#############################################################
performance_schema = ON
performance_schema_consumer_events_statement_history_long = ON

#############################################################
# SECURITY
#############################################################
local_infile = OFF
secure_file_priv = /var/lib/mysql-files
